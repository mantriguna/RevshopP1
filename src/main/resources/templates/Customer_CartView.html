<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>RevShop - Cart</title>
    <link rel="icon" type="image/png" size="32x32" href="/Images/RevShop_1.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <style>
    body{
    background-color: white !important;
    }
        .cart-card {
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            max-width: 1200px;
            height: 170px;
            align-items: center;
        }
        .product-img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            margin-right: 20px;

        }
        .product-details {
            flex: 1;
            padding-right: 20px;
        }
        .max-discount {
            font-size: 0.9em;
            background-color: #CC0C39;
            color: white;
            padding: 5px 10px;
        }
        .ml-auto {
            margin-left: auto;
        }
        .cart-btn { 
            cursor: pointer; 
        }
        .hidden {
            display: none;
        }
        @media (max-width: 768px) {
            .cart-card {
                flex-direction: column;
                align-items: flex-start;
            }
            .product-img {
                margin-right: 0;
                margin-bottom: 10px;
            }
            .ml-auto {
                margin-left: 0;
                width: 100%;
                display: flex;
                justify-content: space-between;
           
            }
        }
        .cart-summary-box {
            border: 2px solid #ffd700;
            padding: 20px;
            border-radius: 10px;
            background-color: #fffaf0;
            margin-top: 20px;
            text-align: right;
        }
        .place-order-btn {
            background-color: #ffd700;
            color: #ffffff;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
        }
        .place-order-btn:hover {
            background-color: #ffcc00;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div th:insert="~{Customer_navbar.html}"></div>
    <div class="container">
        <div class="row">
            <h1 class="product-container mt-4">My Cart</h1>
            <hr>
            <div class="col-12">
                <div th:if="${cartItems.size() == 0}" class="text-center" style="position: relative; display: inline-block;">
				    <p style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 24px; font-weight: bold; background-color:black; border-radius:10px;">
				        &nbsp;&nbsp;Your cart is empty &nbsp;&nbsp;
				    </p>
				    <video autoplay loop muted style="width: 40%; height: 50%; margin-top: 20px;">
				        <source src="https://cdnl.iconscout.com/lottie/premium/preview-watermark/empty-cart-animated-icon-download-in-lottie-json-gif-static-svg-file-formats--shopping-ecommerce-trolley-general-pack-business-icons-9949064.mp4" type="video/mp4">
				        Your browser does not support the video tag.
				    </video>
				</div>
                
                
                <div th:each="item : ${cartItems}" class="cart-card d-flex align-items-center">

                    <div class="product-container" th:if="${item.color != null}">
                        <a th:href="@{/customerproduct/displayproducts/{id}(id=${item.product.productId})}">
                            <div class="image-container">
                                <img th:each="image : ${item.product.imageUrls}"
                                     th:src="${image.imageUrl}"
                                     alt="Product Image Thumbnail"
                                     class="img-thumbnail product-img">
                            </div>
                        </a>
                    </div>

                    <div class="product-details">
                        <h5 th:text="${item.product.productName}">Product Name</h5>
                        <span class="max-discount" th:text="${#numbers.formatDecimal(item.product.maxDiscount, 0, 0)} + '% off'">Max Discount</span>

                        <p><strong>Color:</strong> <span th:text="${item.color != null ? item.color.colorName : 'N/A'}">N/A</span></p>
                        
                        
                        <p><strong>Discount Price:</strong> ₹<span th:text="${#numbers.formatDecimal(item.product.price - (item.product.maxDiscount * item.product.price / 100), 0, 0)}">800</span></p>
                    </div>
                    <form method="post" th:action="@{/cart/updateCartQuantity}" class="ml-auto d-flex align-items-center pe-3" >
					    <input type="hidden" name="cartId" th:value="${item.cartId}" />
					    <button type="submit" name="action" value="decrease" class="btn btn-outline-secondary" 
					            th:disabled="${item.quantity <= 1}">-</button>
					    <span th:text="${item.quantity}" class="mx-2">1</span>
					    <button type="submit" name="action" value="increase" class="btn btn-outline-secondary">+</button>
					</form>
                    <div class="ml-auto">
                        <button class="btn btn-success cart-btn" th:attr="onclick=|moveToWishlist('${item.cartId}')|">
                            Move to Wishlist
                        </button>
                        <button class="btn btn-danger cart-btn" th:attr="onclick=|removeFromCart('${item.cartId}')|">
                            Remove from Cart
                        </button>
                    </div>
                </div>
            </div>
             <!-- Total Cart Value and Place Order Box -->
            <div th:if="${cartItems.size() > 0}" class="cart-summary-box col-md-6 offset-md-3 mt-4" style="width:98%; margin-left:1%;">
                <h4>Total Cart Value: ₹<span th:text="${#numbers.formatDecimal(totalCartValue, 0, 0)}">0.00</span></h4>
                <form method="get" th:action="@{/order/placeOrder}" class="mt-3">
                    <input type="hidden" name="total_value" th:value="${#numbers.formatDecimal(totalCartValue, 0, 0)}">
                    <button type="submit" class="btn btn-primary" style="border: 2px solid; border-radius: 4px;  padding: 8px 16px;">Place Order</button>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Rotating images within the image container
        document.querySelectorAll('.image-container').forEach(function(container) {
            const images = container.querySelectorAll('img');
            let currentImageIndex = 0;

            images.forEach((img, index) => {
                if (index !== currentImageIndex) {
                    img.classList.add('hidden');
                }
            });

            setInterval(function() {
                images[currentImageIndex].classList.add('hidden');
                currentImageIndex = (currentImageIndex + 1) % images.length;
                images[currentImageIndex].classList.remove('hidden');
            }, 4000);
        });

        // Function to remove item from cart
        function removeFromCart(cartId) {
		    if (confirm('Are you sure you want to remove this item from your cart?')) {
		        fetch(`/cart/remove/${cartId}`, {
		            method: 'DELETE'
		        })
		        .then(response => {
		            if (response.ok) {
		                location.reload();  // Refreshes the page upon successful deletion
		            } else {
		                alert('Failed to remove item from cart. Please try again.');
		            }
		        })
		        .catch(error => {
		            console.error('Error:', error);
		            alert('An error occurred. Please try again later.');
		        });
		    }
		}


        function moveToWishlist(cartId) {
            fetch(`/cart/moveToWishlist/${cartId}`, {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Failed to move item to wishlist. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again later.');
            });
        }

    </script>
</body>
</html>