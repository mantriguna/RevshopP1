<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="/Images/RevShop_1.png" type="image/png">
    <title>RevShop - Edit Product</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

    <script>
    let colorIndex = 0;  // Counter for color inputs
    let imageUrlIndex = 0;  // Counter for image URL inputs

    async function fetchBrandsByCategory(categoryId) {
        const brandSelect = document.querySelector("select[name='brandId']");
        brandSelect.innerHTML = '<option value="">Select Brand</option>'; // Clear existing options

        if (categoryId) {
            try {
                const response = await fetch(`/SellerProduct/brands?categoryId=${categoryId}`);
                if (response.ok) {
                    const brands = await response.json(); // Parse JSON response
                    brands.forEach(brand => {
                        const option = document.createElement('option');
                        option.value = brand.brandId;
                        option.textContent = brand.brandName;
                        brandSelect.appendChild(option); // Add brand options dynamically
                    });
                } else {
                    console.error('Failed to fetch brands for category:', categoryId);
                }
            } catch (error) {
                console.error('Error fetching brands:', error);
            }
        }
    }

    function addColorInput() {
        const colorContainer = document.getElementById('colorInputs');
        const newRow = document.createElement('div');
        newRow.className = 'row mb-2';

        const colorNameCol = document.createElement('div');
        colorNameCol.className = 'col';
        const newColorNameInput = document.createElement('input');
        newColorNameInput.type = 'text';
        newColorNameInput.name = 'colorNames[]';  // Array notation for color names
        newColorNameInput.className = 'form-control';
        newColorNameInput.placeholder = 'Enter Color Name';
        newColorNameInput.required = false;
        colorNameCol.appendChild(newColorNameInput);

        const colorUrlCol = document.createElement('div');
        colorUrlCol.className = 'col';
        const newColorUrlInput = document.createElement('input');
        newColorUrlInput.type = 'url';
        newColorUrlInput.name = 'colorUrls[]';  // Array notation for color URLs
        newColorUrlInput.className = 'form-control';
        newColorUrlInput.placeholder = 'Enter Color URL';
        newColorUrlInput.required = false;
        colorUrlCol.appendChild(newColorUrlInput);

        const deleteButtonCol = document.createElement('div');
        deleteButtonCol.className = 'col-auto';
        const deleteButton = document.createElement('button');
        deleteButton.type = 'button';
        deleteButton.className = 'btn btn-danger';
        deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i> Delete';
        deleteButton.onclick = function() {
            newRow.remove(); // Remove the row from the DOM
        };
        deleteButtonCol.appendChild(deleteButton);

        newRow.appendChild(colorNameCol);
        newRow.appendChild(colorUrlCol);
        newRow.appendChild(deleteButtonCol);
        colorContainer.appendChild(newRow);
    }


    function addImageUrlInput() {
        const imageUrlContainer = document.getElementById('imageUrlInputs');
        const newRow = document.createElement('div');
        newRow.className = 'row mb-2';

        const imageCol = document.createElement('div');
        imageCol.className = 'col';
        const newImageInput = document.createElement('input');
        newImageInput.type = 'url';
        newImageInput.name = 'imageUrls[]';  // Array notation for image URLs
        newImageInput.className = 'form-control';
        newImageInput.placeholder = 'Enter Image URL';
        newImageInput.required = false;
        imageCol.appendChild(newImageInput);

        const deleteButtonCol = document.createElement('div');
        deleteButtonCol.className = 'col-auto';
        const deleteButton = document.createElement('button');
        deleteButton.type = 'button';
        deleteButton.className = 'btn btn-danger';
        deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i> Delete';
        deleteButton.onclick = function() {
            newRow.remove(); // Remove the row from the DOM
        };
        deleteButtonCol.appendChild(deleteButton);

        newRow.appendChild(imageCol);
        newRow.appendChild(deleteButtonCol);
        imageUrlContainer.appendChild(newRow);
    }

    function deleteColor(colorId) {
        if (confirm('Are you sure you want to delete this color?')) {
            // Make a request to delete the color from the server
            fetch(`/SellerProduct/deleteColor/${colorId}`, { method: 'DELETE' })
                .then(response => {
                    if (response.ok) {
                        // Reload the page to reflect changes
                        location.reload();
                    } else {
                        console.error('Failed to delete color:', response);
                    }
                })
                .catch(error => {
                    console.error('Error deleting color:', error);
                });
        }
    }

    function deleteImage(imageId) {
        if (confirm('Are you sure you want to delete this image?')) {
            // Make a request to delete the image from the server
            fetch(`/SellerProduct/deleteImage/${imageId}`, { method: 'DELETE' })
                .then(response => {
                    if (response.ok) {
                        // Reload the page to reflect changes
                        location.reload();
                    } else {
                        console.error('Failed to delete image:', response);
                    }
                })
                .catch(error => {
                    console.error('Error deleting image:', error);
                });
        }
    }


    </script>
</head>
<body>
<div th:insert="~{Seller_navbar.html}"></div>
<div class="container mt-5">
    <h2>Edit Product</h2>
    <hr>

    <form th:action="@{/SellerProduct/updateProduct(productId=${product.productId})}" method="post">
        <!-- Seller ID (Hidden Field) -->
        <input type="hidden" name="sellerId" th:value="${sellerId}">
        <input type="hidden" name="productId" th:value="${productId}">

        <!-- Product Name -->
        <div class="mb-3">
            <label for="productName" class="form-label">Product Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" name="productName" th:value="${product.productName}" placeholder="Enter Product Name" required>
        </div>

        <!-- Category Selection -->
        <div class="mb-3">
            <label for="category" class="form-label">Category <span class="text-danger">*</span></label>
            <select class="form-select" name="categoryId" th:value="${product.category.categoryId}" required onchange="fetchBrandsByCategory(this.value)">
                <option value="">Select Category</option>
                <th:block th:each="category : ${categories}">
                    <option th:value="${category.categoryId}" th:text="${category.categoryName}"></option>
                </th:block>
            </select>
        </div>

        <!-- Brand Selection -->
        <div class="mb-3">
            <label for="brand" class="form-label">Brand <span class="text-danger">*</span></label>
            <select class="form-select" name="brandId" th:value="${product.brand.brandId}" required>
                <option value="">Select Brand</option>
                <th:block th:each="brand : ${brands}">
                    <option th:value="${brand.brandId}" th:text="${brand.brandName}"></option>
                </th:block>
            </select>
        </div>

        <!-- Description Input -->
        <div class="mb-3">
            <label for="description" class="form-label">Description <span class="text-danger">*</span></label>
            <textarea class="form-control" name="description" th:text="${product.description}" placeholder="Enter Product Description" rows="4" required></textarea>
            <small class="form-text text-muted">Provide a brief description of the product.</small>
        </div>
        <!-- Color Input Section -->
		<div id="colorInputs" class="mb-3">
		    <label for="colors" class="form-label">Colors <span class="text-danger">*</span></label>
		    <th:block th:each="color : ${product.colors}">
		        <div class="row mb-2" id="color-row-${color.colorId}">
		            <div class="col">
		                <input type="text" class="form-control" name="colorNames[]" th:value="${color.colorName}" placeholder="Enter Color Name" required>
		            </div>
		            <div class="col">
		                <input type="url" class="form-control" name="colorUrls[]" th:value="${color.colorUrl}" placeholder="Enter Color URL" required>
		            </div>
		            <div class="col-auto">
		                <button type="button" class="btn btn-danger" th:onclick="'deleteColor(' + ${color.colorId} + ')'"><i class="fas fa-trash-alt"></i>Delete</button>
		            </div>
		        </div>
		    </th:block>
		</div>
		<button type="button" class="btn btn-secondary mt-2" onclick="addColorInput()">Add Another Color</button>
		

		<!-- Image URLs Section -->
		<div id="imageUrlInputs" class="mb-3">
		    <label for="imageUrls" class="form-label">Image URLs <span class="text-danger">*</span></label>
		    <th:block th:each="image : ${product.imageUrls}">
		        <div class="row mb-2" id="image-row-${image.imageId}">
		            <div class="col">
		                <input type="url" class="form-control" name="imageUrls[]" th:value="${image.imageUrl}" placeholder="Enter Image URL" required>
		            </div>
		            <div class="col-auto">
		                <button type="button" class="btn btn-danger" th:onclick="'deleteImage('+${image.imageId}+')'"><i class="fas fa-trash-alt"></i>Delete</button>
		            </div>
		        </div>
		    </th:block>
		</div>
		<button type="button" class="btn btn-secondary mt-2" onclick="addImageUrlInput()">Add Another Image URL</button>
		 <!-- Price Input -->
        <div class="mb-3">
            <label for="price" class="form-label">Price <span class="text-danger">*</span></label>
            <input type="number" class="form-control" name="price" th:value="${product.price}" placeholder="Enter Price" required>
        </div>

        <!-- Discount Input -->
        <div class="mb-3">
            <label for="discount" class="form-label">Discount (%)</label>
            <input type="number" class="form-control" name="maxDiscount" th:value="${product.maxDiscount}" placeholder="Enter Discount Percentage" min="0" max="100">
            <small class="form-text text-muted">Optional: Enter a discount percentage if applicable.</small>
        </div>
		
        
        
        <!-- Stock Quantity Input -->
        <div class="mb-3">
            <label for="stockQuantity" class="form-label">Stock Quantity <span class="text-danger">*</span></label>
            <input type="number" class="form-control" name="stockQuantity" th:value="${product.stockQuantity}" placeholder="Enter Stock Quantity" required>
        </div>
        <!-- Threshold Input -->
        <div class="mb-3">
            <label for="threshold" class="form-label">Threshold <span class="text-danger">*</span></label>
            <input type="number" class="form-control" name="threshold" th:value="${product.threshold}" placeholder="Enter Stock Threshold" required>
        </div>
         <!-- Seller ID (Hidden Field) -->
        <input type="hidden" name="sellerId" th:value="${sellerId}">
        

        <!-- Submit Button -->
        <div class="mb-3">
            <button type="submit" class="btn btn-primary">Update Product</button>
            <a th:href="@{/SellerProduct/showproducts}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<!-- Bootstrap JS (optional) -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>
</body>
</html>
                        
